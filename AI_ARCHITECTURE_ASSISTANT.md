# AI æ¶æ„åŠ©æ‰‹ åŠŸèƒ½é€»è¾‘æ–‡æ¡£

> æœ¬æ–‡æ¡£è¯¦ç»†æ¢³ç† Excalidraw ä¸­ AI æ¶æ„åŠ©æ‰‹ çš„å®Œæ•´åŠŸèƒ½é€»è¾‘ã€æ•°æ®æµå’Œæ¶æ„è®¾è®¡ã€‚
>
> æœ€åæ›´æ–°ï¼š2026-02-07

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¶æ„æ¦‚è§ˆ](#åŠŸèƒ½æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)
3. [æ•°æ®æµå›¾](#æ•°æ®æµå›¾)
4. [å…³é”®æµç¨‹è¯¦è§£](#å…³é”®æµç¨‹è¯¦è§£)
5. [Prompt è®¾è®¡](#prompt-è®¾è®¡)
6. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)

---

## åŠŸèƒ½æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·äº¤äº’å±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è¾“å…¥æ¡†æé—®   â”‚  â”‚ ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ  â”‚  â”‚ åº”ç”¨åˆ°ç”»å¸ƒ       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                     â”‚
          â–¼                 â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸šåŠ¡é€»è¾‘å±‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ messagesReducerâ”‚  â”‚extractDiagramInfoâ”‚  â”‚convertMermaid   â”‚  â”‚
â”‚  â”‚ (æ¶ˆæ¯çŠ¶æ€ç®¡ç†)  â”‚  â”‚(æå–ç”»å¸ƒä¿¡æ¯)    â”‚  â”‚(Mermaidè½¬Excal) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                    â”‚                     â”‚           â”‚
â”‚          â–¼                    â–¼                     â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   AI Service å±‚                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚callAIStream    â”‚  â”‚generateOptimizationPlan      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚(æµå¼è°ƒç”¨AI)    â”‚  â”‚(ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ+Mermaidä»£ç )    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤–éƒ¨æœåŠ¡å±‚                            â”‚
â”‚              OpenAI API / ç¬¬ä¸‰æ–¹å…¼å®¹ API                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. AI æœåŠ¡å±‚ (`aiService.ts`)

#### 1.1 API é…ç½®ç®¡ç†

```typescript
export interface AISettings {
  apiUrl: string;   // API åœ°å€
  apiKey: string;   // API å¯†é’¥
  model: string;    // æ¨¡å‹åç§°
}

// æ ¸å¿ƒå‡½æ•°
export const getAISettings = (): AISettings | null;
export const setAISettings = (settings: AISettings): void;
export const isAIConfigured = (): boolean;
```

#### 1.2 URL æ™ºèƒ½å¤„ç† (`normalizeApiUrl`)

```typescript
/**
 * æ”¯æŒä¸¤ç§è¾“å…¥æ–¹å¼ï¼š
 * 1. ä»…å¡«åŸŸå -> è‡ªåŠ¨è¡¥å…¨æ¥å£åœ°å€
 *    "https://api.openai.com" â†’ "https://api.openai.com/v1/chat/completions"
 *
 * 2. å¡«å†™å®Œæ•´åœ°å€ -> ç›´æ¥ä½¿ç”¨
 *    "https://api.openai.com/v1/chat/completions" â†’ ä¿æŒä¸å˜
 */
const normalizeApiUrl = (url: string, preferResponses = false): string
```

**å¤„ç†é€»è¾‘ï¼š**

| è¾“å…¥ç¤ºä¾‹ | è¾“å‡ºç¤ºä¾‹ | è¯´æ˜ |
| --- | --- | --- |
| `https://api.openai.com` | `https://api.openai.com/v1/chat/completions` | è‡ªåŠ¨è¡¥å…¨ç‰ˆæœ¬å’Œç«¯ç‚¹ |
| `https://api.openai.com/v1` | `https://api.openai.com/v1/chat/completions` | è¿½åŠ ç«¯ç‚¹è·¯å¾„ |
| `https://api.openai.com/v1/chat/completions` | ä¿æŒä¸å˜ | å®Œæ•´åœ°å€ç›´æ¥ä½¿ç”¨ |
| `https://ark.cn-beijing.volces.com/api/v3` | `.../api/v3/chat/completions` | æ”¯æŒç¬¬ä¸‰æ–¹ API |

#### 1.3 æµå¼ AI è°ƒç”¨

```typescript
export interface StreamCallbacks {
  onChunk: (chunk: string) => void;           // æ¥æ”¶æ–‡æœ¬ç‰‡æ®µ
  onReasoning?: (chunk: string) => void;       // æ¥æ”¶æ¨ç†è¿‡ç¨‹
  onComplete?: () => void;                     // å®Œæˆå›è°ƒ
  onError?: (error: Error) => void;            // é”™è¯¯å›è°ƒ
  includeReasoning?: boolean;                   // æ˜¯å¦åŒ…å«æ¨ç†
}

export const callAIStream = async (
  messages: AIMessage[],
  callbacks: StreamCallbacks,
  signal?: AbortSignal,
  customSettings?: AISettings,
): Promise<{ success: boolean; error?: string }>
```

#### 1.4 ç”»å¸ƒä¿¡æ¯æå–

```typescript
export const extractDiagramInfo = (elements: readonly any[]): string
```

**æå–å†…å®¹ï¼š**

- **å…ƒç´ ç»Ÿè®¡**ï¼šçŸ©å½¢ã€ç®­å¤´ã€æ–‡æœ¬ç­‰å„ç±»å‹æ•°é‡
- **æ–‡æœ¬æ ‡ç­¾**ï¼šç»„ä»¶åç§°ã€æè¿°æ–‡å­—
- **è¿æ¥å…³ç³»**ï¼šç®­å¤´è¿æ¥ï¼ˆA â†’ B è¡¨ç¤º A æŒ‡å‘ Bï¼‰

**è¾“å‡ºç¤ºä¾‹ï¼š**

```markdown
## å›¾è¡¨å…ƒç´ ç»Ÿè®¡

- rectangle: 5 ä¸ª
- arrow: 3 ä¸ª
- text: 2 ä¸ª

## æ–‡æœ¬æ ‡ç­¾

- ç”¨æˆ·æœåŠ¡
- è®¢å•æœåŠ¡
- åº“å­˜æœåŠ¡

## è¿æ¥å…³ç³»

- ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡
- è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡
```

### 2. æ¶æ„åŠ©æ‰‹å¯¹è¯æ¡† (`ArchitectureOptimizationDialog.tsx`)

#### 2.1 çŠ¶æ€ç®¡ç†

```typescript
// æ ¸å¿ƒçŠ¶æ€
const [messages, dispatchMessages] = useReducer(messagesReducer, ...);
const [schemes, setSchemes] = useState<Scheme[]>([]);
const [activeSchemeId, setActiveSchemeId] = useState<string | null>(null);
const [isCompareMode, setIsCompareMode] = useState(false);
```

**æ•°æ®ç»“æ„ï¼š**

```typescript
// æ¶ˆæ¯
interface Message {
  id: string;
  role: "user" | "assistant" | "system";
  content: string;
  isGenerating?: boolean;
  error?: string;
}

// ä¼˜åŒ–æ–¹æ¡ˆ
interface Scheme {
  id: string;
  version: number;
  summary: string; // å®Œæ•´æ€»ç»“
  shortSummary: string; // ç®€çŸ­æ€»ç»“ï¼ˆæ ‡ç­¾ç”¨ï¼‰
  mermaid: string; // Mermaid å›¾è¡¨ä»£ç 
  title?: string;
}
```

#### 2.2 æ ¸å¿ƒåŠŸèƒ½æµç¨‹

**A. åˆå§‹åŒ–åˆ†ææµç¨‹**

```
ç”¨æˆ·æ‰“å¼€å¯¹è¯æ¡†
    â†“
æ£€æŸ¥ AI é…ç½® (isAIConfigured)
    â†“
æå–ç”»å¸ƒå…ƒç´  (extractDiagramInfo)
    â†“
æ„å»ºåˆ†æ Prompt
    â†“
è°ƒç”¨ AI æµå¼è¾“å‡º (callAIStream)
    â†“
å®æ—¶æ˜¾ç¤ºåœ¨å¯¹è¯åŒºåŸŸ
```

**B. ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆæµç¨‹**

````
ç”¨æˆ·ç‚¹å‡»"âœ¨ ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ"
    â†“
æ„å»ºä¼˜åŒ– Prompt (åŒ…å«å¯¹è¯å†å²)
    â†“
è°ƒç”¨ generateOptimizationPlan
    â†“
AI è¿”å›ï¼š
   â”œâ”€ ## å˜æ›´æ€»ç»“
   â””â”€ ```mermaid ... ```
    â†“
è§£æè¿”å›å†…å®¹
    â†“
åˆ›å»ºæ–° Scheme å¯¹è±¡
    â†“
æ¸²æŸ“ Mermaid é¢„è§ˆ (convertMermaidToExcalidraw)
    â†“
å³ä¾§æ˜¾ç¤ºæ–°æ¶æ„å›¾
````

**C. åº”ç”¨æ–¹æ¡ˆåˆ°ç”»å¸ƒ**

```
ç”¨æˆ·ç‚¹å‡»"åº”ç”¨åˆ°ç”»å¸ƒ"
    â†“
è·å–å½“å‰ Scheme çš„ Mermaid ä»£ç 
    â†“
convertMermaidToExcalidraw è½¬æ¢ä¸ºå…ƒç´ 
    â†“
æ’å…¥åˆ°å½“å‰ç”»å¸ƒ
    â†“
å…³é—­å¯¹è¯æ¡†
```

#### 2.3 UI å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIæ¶æ„åŠ©æ‰‹                                          [é…ç½®] [X]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚    ğŸ’¬ å¯¹è¯åŒºåŸŸ           â”‚  â”‚         ğŸ“Š é¢„è§ˆåŒºåŸŸ                â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ğŸ¤– AI: åˆ†æä¸­... â”‚   â”‚  â”‚  â”‚                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚      Mermaid å›¾è¡¨             â”‚  â”‚  â”‚
â”‚  â”‚                        â”‚  â”‚  â”‚      (æ¸²æŸ“ä¸º Excalidraw)      â”‚  â”‚  â”‚
â”‚  â”‚  [è¾“å…¥æ¡†...]           â”‚  â”‚  â”‚                               â”‚  â”‚  â”‚
â”‚  â”‚  [å‘é€] [âœ¨ç”Ÿæˆæ–¹æ¡ˆ]   â”‚  â”‚  â”‚                               â”‚  â”‚  â”‚
â”‚  â”‚                        â”‚  â”‚  â”‚                               â”‚  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚                              â”‚                                       â”‚  â”‚
â”‚                              â”‚  [å¯¹æ¯”æ¨¡å¼] [ç‰ˆæœ¬1] [ç‰ˆæœ¬2] [ç‰ˆæœ¬3]   â”‚  â”‚
â”‚                              â”‚                                       â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Prompt è®¾è®¡

### 1. æ¶æ„åˆ†æ Prompt (`getArchitectureAnalysisPrompt`)

**ç›®æ ‡**ï¼šåˆ†æå½“å‰æ¶æ„å›¾ï¼Œæä¾›ä¼˜åŒ–å»ºè®®

```markdown
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç³»ç»Ÿæ¶æ„å¸ˆã€‚è¯·åˆ†æä»¥ä¸‹æ¶æ„å›¾å¹¶æä¾›ä¼˜åŒ–å»ºè®®ã€‚

<å›¾è¡¨ä¿¡æ¯>

## å›¾è¡¨å…ƒç´ ç»Ÿè®¡

- rectangle: 5 ä¸ª
- arrow: 3 ä¸ª ...

## æ–‡æœ¬æ ‡ç­¾

- ç”¨æˆ·æœåŠ¡
- è®¢å•æœåŠ¡ ...

## è¿æ¥å…³ç³»

- ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ ... </å›¾è¡¨ä¿¡æ¯>

è¯·ä»ä»¥ä¸‹æ–¹é¢åˆ†æï¼š

1. ç»„ä»¶åˆ’åˆ†æ˜¯å¦åˆç†
2. ç»„ä»¶é—´è€¦åˆåº¦
3. å¯æ‰©å±•æ€§è€ƒè™‘
4. æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆ
5. å®‰å…¨æ€§å»ºè®®
6. æ¨èçš„ä¼˜åŒ–æ–¹å‘

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œä½¿ç”¨æ¸…æ™°çš„ç»“æ„å’Œè¦ç‚¹ã€‚
```

**è®¾è®¡è¦ç‚¹ï¼š**

- æ˜ç¡®è§’è‰²å®šä½ï¼šä¸“ä¸šç³»ç»Ÿæ¶æ„å¸ˆ
- æä¾›ç»“æ„åŒ–è¾“å…¥ï¼ˆå›¾è¡¨ä¿¡æ¯ï¼‰
- æŒ‡å®šåˆ†æç»´åº¦ï¼ˆ6 ä¸ªæ–¹é¢ï¼‰
- è¦æ±‚ä¸­æ–‡å›ç­”ã€ç»“æ„æ¸…æ™°

---

### 2. ä¼˜åŒ–æ–¹æ¡ˆ Prompt (`getOptimizationPlanPrompt`)

**ç›®æ ‡**ï¼šåŸºäºå¯¹è¯å†å²ç”Ÿæˆå®Œæ•´çš„ä¼˜åŒ–æ–¹æ¡ˆï¼ˆå« Mermaid å›¾è¡¨ï¼‰

````markdown
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç³»ç»Ÿæ¶æ„å¸ˆã€‚æ ¹æ®å½“å‰æ¶æ„å›¾ä¿¡æ¯å’Œæˆ‘ä»¬çš„å¯¹è¯è®°å½•ï¼Œç”Ÿæˆä¸€ä¸ªä¼˜åŒ–æ–¹æ¡ˆã€‚

<å½“å‰æ¶æ„å›¾ä¿¡æ¯> [åŒåˆ†æ Prompt çš„å›¾è¡¨ä¿¡æ¯] </å½“å‰æ¶æ„å›¾ä¿¡æ¯>

<å¯¹è¯å†å²> user: å¦‚ä½•æé«˜è¿™ä¸ªæ¶æ„çš„å¯æ‰©å±•æ€§ï¼Ÿ assistant: å»ºè®®å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦æœåŠ¡é—´çš„ç›´æ¥è°ƒç”¨... </å¯¹è¯å†å²>

ä½ çš„ä»»åŠ¡æ˜¯ï¼š

1. æ€»ç»“å¯¹è¯ä¸­è®¨è®ºçš„ä¼˜åŒ–å»ºè®®
2. ç”Ÿæˆä¸€ä¸ªæœ‰æ•ˆçš„ Mermaid å›¾è¡¨ä»£ç ï¼Œè¡¨ç¤ºä¼˜åŒ–åçš„æ–°æ¶æ„

ã€é‡è¦ã€‘è¾“å‡ºæ ¼å¼è¦æ±‚ï¼šä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–å†…å®¹ï¼š

## å˜æ›´æ€»ç»“

- [å˜æ›´ 1]
- [å˜æ›´ 2]
- [å˜æ›´ 3]

```mermaid
graph TD
    A[ç»„ä»¶1] --> B[ç»„ä»¶2]
    B --> C[ç»„ä»¶3]
```
````

æ³¨æ„äº‹é¡¹ï¼š

- Mermaid ä»£ç å¿…é¡»æ˜¯æœ‰æ•ˆçš„ flowchart/graph è¯­æ³•
- å¿…é¡»åŒ…å«å®Œæ•´çš„æ¶æ„ï¼Œè€Œä¸ä»…ä»…æ˜¯å˜æ›´éƒ¨åˆ†
- ä½¿ç”¨ä¸­æ–‡æ ‡ç­¾
- ç¡®ä¿ä»£ç åœ¨ä¸‰ä¸ªåå¼•å·å†…ï¼Œå¹¶æ ‡è®°ä¸º mermaid

````

**è®¾è®¡è¦ç‚¹ï¼š**
- åŸºäºå¯¹è¯å†å²ï¼Œç¡®ä¿è¿ç»­æ€§
- å¼ºåˆ¶è¾“å‡ºæ ¼å¼ï¼ˆ## å˜æ›´æ€»ç»“ + ```mermaidï¼‰
- è¦æ±‚å®Œæ•´æ¶æ„ï¼ˆä¸æ˜¯ diffï¼‰
- ä½¿ç”¨ä¸­æ–‡æ ‡ç­¾ï¼ˆç¬¦åˆç”¨æˆ·åœºæ™¯ï¼‰
- åŒ…å«æ³¨æ„äº‹é¡¹ç¡®ä¿è¾“å‡ºè´¨é‡

---

## ä¼˜åŒ–å»ºè®®

åŸºäºä»£ç åˆ†æï¼Œä»¥ä¸‹æ˜¯å¯ä¼˜åŒ–çš„æ–¹å‘ï¼š

### 1. Prompt å·¥ç¨‹ä¼˜åŒ–

**ç°çŠ¶é—®é¢˜ï¼š**
- Mermaid è¯­æ³•æœ‰æ—¶ä¸è§„èŒƒ
- ç”Ÿæˆçš„æ¶æ„å›¾å¯èƒ½ä¸ç¬¦åˆæœ€ä½³å®è·µ

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```typescript
// æ·»åŠ  few-shot ç¤ºä¾‹
const fewShotExamples = `
ç¤ºä¾‹1 - å¾®æœåŠ¡æ¶æ„ï¼š
\`\`\`mermaid
graph TD
    A[API Gateway] --> B[User Service]
    A --> C[Order Service]
    B --> D[(User DB)]
    C --> E[(Order DB)]
    C --> F[Message Queue]
\`\`\`

ç¤ºä¾‹2 - äº‹ä»¶é©±åŠ¨æ¶æ„ï¼š
...
`;

// åœ¨ Prompt ä¸­é™„åŠ ç¤ºä¾‹
const enhancedPrompt = basePrompt + '\n\n' + fewShotExamples;
````

**é¢„æœŸæ”¶ç›Šï¼š**

- æå‡ Mermaid è¯­æ³•æ­£ç¡®ç‡ 30%+
- ç”Ÿæˆçš„æ¶æ„æ›´ç¬¦åˆè¡Œä¸šæ ‡å‡†

---

### 2. é”™è¯¯å¤„ç†å¢å¼º

**ç°çŠ¶é—®é¢˜ï¼š**

- Mermaid è§£æå¤±è´¥æ—¶ç”¨æˆ·ä½“éªŒå·®
- AI è¿”å›æ ¼å¼ä¸ç¬¦æ—¶æ— é‡è¯•æœºåˆ¶

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```typescript
// æ·»åŠ  Mermaid è¯­æ³•ä¿®å¤å™¨
const fixMermaidSyntax = (code: string): string => {
  let fixed = code;
  // ä¿®å¤å¸¸è§é”™è¯¯
  fixed = fixed.replace(/graph\s+\w+\s*\n/g, 'graph TD\n'); // ä¿®å¤æ–¹å‘å£°æ˜
  fixed = fixed.replace(/\[\s*([^\]]+?)\s*\]/g, '[$1]'); // ä¿®å¤ç©ºæ ¼é—®é¢˜
  return fixed;
};

// æ·»åŠ é‡è¯•æœºåˆ¶
const generateWithRetry = async (prompt: string, maxRetries = 3): Promise<string> => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const result = await callAIStream(...);
      if (validateFormat(result)) {
        return result;
      }
      // æ ¼å¼ä¸ç¬¦ï¼Œæ·»åŠ æç¤ºé‡è¯•
      prompt += '\n\n[æ³¨æ„ï¼šä¸Šæ¬¡è¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„æ ¼å¼è¾“å‡º]';
    } catch (e) {
      if (i === maxRetries - 1) throw e;
    }
  }
  throw new Error('Max retries exceeded');
};
```

**é¢„æœŸæ”¶ç›Šï¼š**

- æå‡å¥å£®æ€§ï¼Œå‡å°‘ç”¨æˆ·çœ‹åˆ°é”™è¯¯é¡µé¢çš„æ¦‚ç‡ 50%+
- æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œæ— éœ€æ‰‹åŠ¨é‡è¯•

---

### 3. æ€§èƒ½ä¼˜åŒ–

**ç°çŠ¶é—®é¢˜ï¼š**

- å¤§ç”»å¸ƒæ—¶åˆ†æè€—æ—¶è¿‡é•¿
- æ¯æ¬¡æ‰“å¼€éƒ½é‡æ–°åˆ†æï¼Œæ— ç¼“å­˜

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```typescript
// æ·»åŠ åˆ†æç»“æœç¼“å­˜
const analysisCache = new Map<
  string,
  {
    timestamp: number;
    elementCount: number;
    result: string;
  }
>();

const getCachedAnalysis = (elements: readonly any[]): string | null => {
  const hash = hashElements(elements); // ç®€åŒ–çš„å…ƒç´ å“ˆå¸Œ
  const cached = analysisCache.get(hash);

  if (
    cached &&
    Date.now() - cached.timestamp < 5 * 60 * 1000 && // 5åˆ†é’Ÿç¼“å­˜
    cached.elementCount === elements.length
  ) {
    return cached.result;
  }
  return null;
};

// å¢é‡åˆ†æï¼ˆå¤§ç”»å¸ƒä¼˜åŒ–ï¼‰
const extractDiagramInfoIncremental = (
  elements: readonly any[],
  previousInfo?: DiagramInfo,
): DiagramInfo => {
  // åªåˆ†æå¯è§†åŒºåŸŸå†…çš„å…ƒç´ 
  const visibleElements = elements.filter(
    (el) =>
      el.x >= viewport.x &&
      el.x <= viewport.x + viewport.width &&
      el.y >= viewport.y &&
      el.y <= viewport.height,
  );

  // åˆå¹¶ä¹‹å‰çš„åˆ†æç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
  if (previousInfo) {
    return mergeDiagramInfo(previousInfo, visibleElements);
  }

  return extractDiagramInfo(visibleElements);
};
```

**é¢„æœŸæ”¶ç›Šï¼š**

- å¤§ç”»å¸ƒåˆ†ææ€§èƒ½æå‡ 60%+
- é‡å¤æ‰“å¼€å¯¹è¯æ¡†æ—¶å“åº”æ›´å¿«

---

### 4. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

**ç°çŠ¶é—®é¢˜ï¼š**

- æ— åŠ è½½çŠ¶æ€ï¼Œç”¨æˆ·ä¸çŸ¥é“æ˜¯å¦åœ¨å·¥ä½œ
- ä¸æ”¯æŒ Markdown æ ¼å¼å›å¤

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```typescript
// æ·»åŠ åŠ è½½éª¨æ¶å±
const MessageSkeleton = () => (
  <div className="message-skeleton">
    <div className="skeleton-avatar" />
    <div className="skeleton-content">
      <div className="skeleton-line" style={{ width: "80%" }} />
      <div className="skeleton-line" style={{ width: "60%" }} />
      <div className="skeleton-line" style={{ width: "40%" }} />
    </div>
  </div>
);

// æ”¯æŒ Markdown æ¸²æŸ“
import ReactMarkdown from "react-markdown";

const MessageContent = ({ content }: { content: string }) => {
  // æ£€æµ‹æ˜¯å¦åŒ…å« Markdown
  const hasMarkdown = /[#*`\[\]()]/.test(content);

  if (hasMarkdown) {
    return (
      <ReactMarkdown
        components={{
          code: ({ node, inline, className, children, ...props }) => (
            <code className={className} {...props}>
              {children}
            </code>
          ),
        }}
      >
        {content}
      </ReactMarkdown>
    );
  }

  return <span>{content}</span>;
};
```

**é¢„æœŸæ”¶ç›Šï¼š**

- æå‡æ„ŸçŸ¥æ€§èƒ½ï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…ç„¦è™‘
- æ›´å¥½çš„å†…å®¹å±•ç¤ºæ•ˆæœï¼ˆä»£ç é«˜äº®ã€åˆ—è¡¨ç­‰ï¼‰

---

## ğŸ“Š æ€»ç»“

### å½“å‰ç³»ç»Ÿäº®ç‚¹

1. **å®Œæ•´çš„ AI å·¥ä½œæµ**ï¼šä»ç”»å¸ƒåˆ†æ â†’ AI å¯¹è¯ â†’ æ–¹æ¡ˆç”Ÿæˆ â†’ å¯è§†åŒ–é¢„è§ˆ â†’ åº”ç”¨ç”»å¸ƒï¼Œå½¢æˆé—­ç¯
2. **æ™ºèƒ½ URL å¤„ç†**ï¼šæ”¯æŒå¤šç§ API é…ç½®æ–¹å¼ï¼Œæå‡å…¼å®¹æ€§
3. **æ•°æ®æŒä¹…åŒ–**ï¼šèŠå¤©å†å²å’Œæ–¹æ¡ˆå¯ä¿å­˜ã€å¯å¯¼å‡º
4. **æµå¼äº¤äº’**ï¼šAI å›å¤å®æ—¶æ˜¾ç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### å»ºè®®ä¼˜åŒ–ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹          | é¢„æœŸæ”¶ç›Š               |
| ------ | --------------- | ---------------------- |
| P0     | Prompt å·¥ç¨‹ä¼˜åŒ– | æå‡ Mermaid è´¨é‡ 30%+ |
| P0     | é”™è¯¯å¤„ç†å¢å¼º    | å‡å°‘é”™è¯¯ç‡ 50%+        |
| P1     | æ€§èƒ½ä¼˜åŒ–        | å¤§ç”»å¸ƒåˆ†ææé€Ÿ 60%+    |
| P1     | ç”¨æˆ·ä½“éªŒä¼˜åŒ–    | æå‡æ»¡æ„åº¦             |

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **ä¸»ç»„ä»¶**: `packages/excalidraw/components/ArchitectureOptimizationDialog.tsx`
- **æ¶ˆæ¯çŠ¶æ€**: `packages/excalidraw/components/ArchitectureOptimizationDialog/messageState.ts`
- **AI æœåŠ¡**: `packages/excalidraw/services/aiService.ts`
- **æ ·å¼æ–‡ä»¶**: `packages/excalidraw/components/ArchitectureOptimizationDialog.scss`
- **æ•°æ®ç±»å‹**: `packages/excalidraw/data/types.ts`

---

_æ–‡æ¡£ç»“æŸ_
